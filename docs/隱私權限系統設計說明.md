# 隱私權限系統設計說明

## 核心概念：基於地點關聯的隱私權限

本系統採用**基於地點關聯**的隱私權限設計，確保只有相關當事人才能看到敏感的聯絡資訊。

## 三種角色關係

### A - 需求端（網格建立者）
- **定義**：建立救災網格的人，發起需求的一方
- **資料表欄位**：`grids.created_by_id`
- **隱私規則**：**聯絡資訊永遠公開**
- **原因**：讓志工和捐贈者能夠聯繫需求發起人

### B - 志工端（志工報名者）
- **定義**：在特定網格報名的志工
- **資料表欄位**：`volunteer_registrations.created_by_id` 或 `volunteer_registrations.user_id`
- **隱私規則**：只有該網格的建立者 A 才能看到 B 的聯絡資訊
- **地點關聯**：依照報名的地點（網格）關聯到建立者 A

### C - 物資捐贈者
- **定義**：在特定網格捐贈物資的人
- **資料表欄位**：`supply_donations.created_by_id`
- **隱私規則**：只有該網格的建立者 A 才能看到 C 的聯絡資訊
- **地點關聯**：依照捐贈物資的地點（網格）關聯到建立者 A

## 隱私顯示規則

### 規則 1：A 的聯絡資訊永遠公開
```
任何人都可以看到網格建立者 A 的聯絡資訊
→ 讓 B 和 C 能夠聯繫需求發起人
```

### 規則 2：B 的聯絡資訊基於地點關聯
```
只有「B 報名的網格」的建立者 A 才能看到 B 的聯絡方式
→ 實現精準的隱私控制
```

**範例**：
- A₁ 建立了「花蓮市區 A1 網格」
- A₂ 建立了「花蓮市區 A2 網格」
- B 在 A1 網格報名當志工
- ✅ A₁ **可以**看到 B 的電話/Email（因為 B 報名的是 A₁ 的網格）
- ❌ A₂ **不能**看到 B 的電話/Email（因為 B 沒有報名 A₂ 的網格）
- ✅ B **可以**看到自己的聯絡資訊

### 規則 3：C 的聯絡資訊基於地點關聯
```
只有「C 捐贈物資的網格」的建立者 A 才能看到 C 的聯絡方式
→ 實現精準的隱私控制
```

**範例**：
- A₁ 建立了「花蓮市區 A1 網格」
- A₂ 建立了「花蓮市區 A2 網格」
- C 在 A1 網格捐贈礦泉水
- ✅ A₁ **可以**看到 C 的電話/Email（因為 C 捐贈給 A₁ 的網格）
- ❌ A₂ **不能**看到 C 的電話/Email（因為 C 沒有捐贈給 A₂ 的網格）
- ✅ C **可以**看到自己的聯絡資訊

## 管理權限

### 網格管理權
- A 是該網格的管理員
- A、B、C 三者都可以對相應的任務做狀態調整

### 狀態調整權限
| 角色 | 可調整的狀態 |
|------|-------------|
| A（網格建立者） | 可調整該網格的所有志工報名和物資捐贈的狀態 |
| B（志工） | 可調整自己的志工報名狀態（如：取消報名、更新可服務時間） |
| C（捐贈者） | 可調整自己的物資捐贈狀態（如：取消捐贈、更新配送時間） |

## 角色權限矩陣

### 檢視志工聯絡資訊 (view_volunteer_contact)

| 角色 | 權限範圍 | 說明 |
|------|---------|------|
| 訪客 | ❌ 無權限 | 無法檢視任何志工的聯絡資訊 |
| 一般使用者 | ✅ 有條件 | 可檢視自己建立的網格中志工的聯絡資訊（A 看 B），以及自己作為志工的聯絡資訊（B 看自己） |
| 網格管理員 | ✅ 全部 | 可檢視所有網格中志工的聯絡資訊 |
| 管理員 | ✅ 全部 | 可檢視所有志工的聯絡資訊 |
| 超級管理員 | ✅ 全部 | 可檢視所有志工的聯絡資訊 |

### 檢視捐贈者聯絡資訊 (view_donor_contact)

| 角色 | 權限範圍 | 說明 |
|------|---------|------|
| 訪客 | ❌ 無權限 | 無法檢視任何捐贈者的聯絡資訊 |
| 一般使用者 | ✅ 有條件 | 可檢視自己建立的網格中捐贈者的聯絡資訊（A 看 C），以及自己作為捐贈者的聯絡資訊（C 看自己） |
| 網格管理員 | ✅ 全部 | 可檢視所有網格中捐贈者的聯絡資訊 |
| 管理員 | ✅ 全部 | 可檢視所有捐贈者的聯絡資訊 |
| 超級管理員 | ✅ 全部 | 可檢視所有捐贈者的聯絡資訊 |

### 檢視網格區域聯絡人資訊 (view_grid_contact)

| 角色 | 權限範圍 | 說明 |
|------|---------|------|
| 訪客 | ✅ 公開資訊 | 可檢視網格建立者（A）的公開資訊 |
| 一般使用者 | ✅ 全部 | 可檢視所有網格建立者（A）的聯絡資訊 |
| 網格管理員 | ✅ 全部 | 可檢視所有網格建立者（A）的聯絡資訊 |
| 管理員 | ✅ 全部 | 可檢視所有網格建立者（A）的聯絡資訊 |
| 超級管理員 | ✅ 全部 | 可檢視所有網格建立者（A）的聯絡資訊 |

## 技術實作

### 資料表結構

```sql
-- 網格表（A 的資訊）
CREATE TABLE grids (
  id TEXT PRIMARY KEY,
  created_by_id TEXT,  -- 網格建立者 A 的 ID
  contact_info TEXT,   -- A 的聯絡資訊（永遠公開）
  ...
);

-- 志工報名表（B 的資訊）
CREATE TABLE volunteer_registrations (
  id TEXT PRIMARY KEY,
  grid_id TEXT,        -- 關聯到哪個網格
  created_by_id TEXT,  -- 志工 B 的 ID
  volunteer_phone TEXT,  -- B 的電話（僅 A 可見）
  volunteer_email TEXT,  -- B 的 Email（僅 A 可見）
  ...
);

-- 物資捐贈表（C 的資訊）
CREATE TABLE supply_donations (
  id TEXT PRIMARY KEY,
  grid_id TEXT,        -- 關聯到哪個網格
  created_by_id TEXT,  -- 捐贈者 C 的 ID
  donor_phone TEXT,    -- C 的電話（僅 A 可見）
  donor_email TEXT,    -- C 的 Email（僅 A 可見）
  ...
);
```

### 隱私過濾函數

檔案位置：`packages/backend/src/lib/privacy-filter.ts`

#### 過濾志工聯絡資訊

```typescript
export function filterVolunteerPrivacy(
  registration: VolunteerRegistration,
  user: User | null,
  gridCreatorId: string | undefined
): VolunteerRegistration {
  // 管理員可以看到所有資訊
  if (isAdmin(user)) {
    return registration;
  }

  // 網格建立者（A）可以看到該網格所有志工（B）的聯絡資訊
  if (user && gridCreatorId && user.id === gridCreatorId) {
    return registration;
  }

  // 志工本人（B）可以看到自己的聯絡資訊
  if (isVolunteerSelf(user, registration)) {
    return registration;
  }

  // 其他人無法看到志工的聯絡資訊
  return {
    ...registration,
    volunteer_phone: undefined,
    volunteer_email: undefined,
  };
}
```

#### 過濾捐贈者聯絡資訊

```typescript
export function filterDonationPrivacy(
  donation: SupplyDonation,
  user: User | null,
  gridCreatorId: string | undefined
): SupplyDonation {
  // 管理員可以看到所有資訊
  if (isAdmin(user)) {
    return donation;
  }

  // 網格建立者（A）可以看到該網格所有捐贈（C）的聯絡資訊
  if (user && gridCreatorId && user.id === gridCreatorId) {
    return donation;
  }

  // 捐贈者本人（C）可以看到自己的聯絡資訊
  if (isDonorSelf(user, donation)) {
    return donation;
  }

  // 其他人無法看到捐贈者的聯絡資訊
  return {
    ...donation,
    donor_name: undefined,
    donor_phone: undefined,
    donor_email: undefined,
  };
}
```

## 使用場景範例

### 場景 1：志工媒合
1. A₁ 在地圖上建立「花蓮市區 A1 網格」，需要 5 名志工
2. B₁ 在 A1 網格報名當志工
3. B₂ 在 A1 網格報名當志工
4. A₂ 建立「花蓮市區 A2 網格」

**隱私顯示結果**：
- A₁ 可以看到 B₁ 和 B₂ 的聯絡方式（因為他們報名了 A₁ 的網格）
- A₂ **不能**看到 B₁ 和 B₂ 的聯絡方式（因為他們沒有報名 A₂ 的網格）
- B₁ 可以看到 A₁ 的聯絡方式（網格建立者資訊永遠公開）
- B₁ 可以看到自己的聯絡資訊
- B₁ **不能**看到 B₂ 的聯絡資訊（志工之間互不可見）

### 場景 2：物資捐贈
1. A₁ 在地圖上建立「花蓮市區 A1 網格」，需要礦泉水
2. C₁ 在 A1 網格捐贈 100 箱礦泉水
3. C₂ 在 A1 網格捐贈 50 個便當
4. A₂ 建立「花蓮市區 A2 網格」

**隱私顯示結果**：
- A₁ 可以看到 C₁ 和 C₂ 的聯絡方式（因為他們捐贈給 A₁ 的網格）
- A₂ **不能**看到 C₁ 和 C₂ 的聯絡方式（因為他們沒有捐贈給 A₂ 的網格）
- C₁ 可以看到 A₁ 的聯絡方式（網格建立者資訊永遠公開）
- C₁ 可以看到自己的聯絡資訊
- C₁ **不能**看到 C₂ 的聯絡資訊（捐贈者之間互不可見）

### 場景 3：狀態調整
1. A₁ 建立「花蓮市區 A1 網格」
2. B₁ 在 A1 報名當志工，狀態為「待確認」
3. C₁ 在 A1 捐贈礦泉水，狀態為「已承諾」

**可調整狀態的人**：
- A₁ 可以調整 B₁ 的志工狀態（如：確認 → 已報到）
- A₁ 可以調整 C₁ 的捐贈狀態（如：已承諾 → 已送達）
- B₁ 可以調整自己的志工狀態（如：取消報名、更新可服務時間）
- C₁ 可以調整自己的捐贈狀態（如：更新配送時間、取消捐贈）

## 權限更新腳本

執行以下腳本可更新資料庫中的隱私權限說明：

```bash
cd packages/backend
npx tsx scripts/add-detailed-privacy-permissions.ts
```

## 驗證權限

執行以下腳本可驗證隱私權限是否正確設定：

```bash
cd packages/backend
npx tsx scripts/verify-privacy-permissions.ts
```

## 總結

這個基於地點關聯的隱私權限系統：

1. ✅ **保護志工隱私**：只有網格建立者能看到在該網格報名的志工聯絡方式
2. ✅ **保護捐贈者隱私**：只有網格建立者能看到在該網格捐贈的捐贈者聯絡方式
3. ✅ **公開需求資訊**：網格建立者的聯絡方式永遠公開，方便志工和捐贈者聯繫
4. ✅ **精準權限控制**：基於地點（網格）關聯，實現精準的隱私控制
5. ✅ **靈活狀態管理**：ABC 三方都能管理自己相關的任務狀態
