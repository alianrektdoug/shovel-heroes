# 志工中心隱私權限修復報告

## 問題描述

志工中心頁面的電話號碼隱私權限沒有正確根據權限設定顯示。

### 預期行為

根據隱私權限系統設計 (`packages/backend/src/lib/privacy-filter.ts`)：

**電話號碼顯示規則**：
1. ✅ **管理員**：可以看到所有志工的電話
2. ✅ **志工本人**：可以看到自己的電話
3. ❌ **網格建立者**：可以看到自己建立的網格中所有志工的電話（**缺失**）
4. ✅ **其他人**：看不到電話

### 實際問題

`/volunteers` API 端點 (`packages/backend/src/routes/volunteers.ts`) 只檢查了：
- 管理員權限
- 志工本人

**缺少**了網格建立者的檢查，導致網格建立者無法看到在自己網格報名的志工電話。

## 根因分析

### 問題代碼位置

**檔案**: `packages/backend/src/routes/volunteers.ts`

**原始程式碼** (第 110-135 行):
```typescript
const { rows } = await app.db.query(sql, params) as { rows: RawRow[] };

// View phone only if admin in admin mode OR user is owner/manager of that grid OR is the volunteer themselves.
// For simplicity: admin mode => true, else we compute per row (mask others).
const canViewAllPhone = isAdminMode;

// Map rows to VolunteerListItem spec shape.
const currentUserId = req.user.id;
const data = rows.map(r => {
  // basic row
  const base = {
    id: r.id,
    grid_id: r.grid_id,
    user_id: r.user_id || undefined,
    volunteer_name: r.volunteer_name || r.user_name || '匿名志工',
    status: r.status || 'pending',
    available_time: r.available_time,
    skills: ensureArray(r.skills),
    equipment: ensureArray(r.equipment),
    notes: r.notes,
    created_date: r.created_at
  };
  // Determine phone visibility: self OR admin mode. For non-admin mode owner/manager check would require join; omitted to avoid extra query.
  const showPhone = canViewAllPhone || (r.user_id && r.user_id === currentUserId);
  return { ...base, volunteer_phone: showPhone ? r.volunteer_phone : undefined };
});
```

**問題**：
- 第 133 行：註解提到需要檢查 "owner/manager"，但實際沒有實作
- 只檢查了 `canViewAllPhone`（管理員）和 `r.user_id === currentUserId`（志工本人）
- 缺少網格建立者（grid creator）的檢查

### 對比正確實作

`/volunteer-registrations` API 的實作是正確的：

**檔案**: `packages/backend/src/routes/volunteer-registrations.ts` (第 26-76 行)

```typescript
// 取得志工報名資料和網格建立者資訊
const { rows } = await app.db.query(`
  SELECT vr.*, g.created_by_id as grid_creator_id
  FROM volunteer_registrations vr
  LEFT JOIN grids g ON g.id = vr.grid_id
  WHERE vr.grid_id = $1
  ORDER BY vr.created_at DESC
`, [gridId]);

// 取得網格建立者 ID
const gridCreatorId = rows.length > 0 ? rows[0].grid_creator_id : undefined;

// 檢查使用者是否為該網格的建立者
const isGridCreator = req.user && gridCreatorId && req.user.id === gridCreatorId;

// 過濾隱私資訊
const filtered = filterVolunteersPrivacy(rows, req.user || null, gridCreatorId);

return {
  data: filtered,
  can_view_phone: isUserAdmin || isGridCreator  // ✅ 正確檢查網格建立者
};
```

## 解決方案

### 修復內容

**檔案**: `packages/backend/src/routes/volunteers.ts`

**修復後程式碼** (第 110-156 行):
```typescript
const { rows } = await app.db.query(sql, params) as { rows: RawRow[] };

// 取得所有網格資訊以檢查使用者是否為網格建立者
const gridIds = [...new Set(rows.map(r => r.grid_id))];
let gridCreatorMap: Record<string, string> = {};

if (gridIds.length > 0) {
  const gridPlaceholders = gridIds.map((_, i) => `$${i + 1}`).join(',');
  const gridSql = `SELECT id, created_by_id FROM grids WHERE id IN (${gridPlaceholders})`;
  const { rows: gridRows } = await app.db.query(gridSql, gridIds);
  gridCreatorMap = gridRows.reduce((acc: Record<string, string>, g: any) => {
    if (g.created_by_id) acc[g.id] = g.created_by_id;
    return acc;
  }, {});
}

// View phone only if admin in admin mode OR user is owner/manager of that grid OR is the volunteer themselves.
// For simplicity: admin mode => true, else we compute per row (mask others).
const canViewAllPhone = isAdminMode;

// Map rows to VolunteerListItem spec shape.
const currentUserId = req.user.id;
const data = rows.map(r => {
  // basic row
  const base = {
    id: r.id,
    grid_id: r.grid_id,
    user_id: r.user_id || undefined,
    volunteer_name: r.volunteer_name || r.user_name || '匿名志工',
    status: r.status || 'pending',
    available_time: r.available_time,
    skills: ensureArray(r.skills),
    equipment: ensureArray(r.equipment),
    notes: r.notes,
    created_date: r.created_at
  };

  // 檢查電話顯示權限：
  // 1. 管理員模式：可以看到所有電話
  // 2. 志工本人：可以看到自己的電話
  // 3. 網格建立者：可以看到自己建立的網格中所有志工的電話
  const isGridCreator = gridCreatorMap[r.grid_id] === currentUserId;
  const isSelf = r.user_id && r.user_id === currentUserId;
  const showPhone = canViewAllPhone || isSelf || isGridCreator;

  return { ...base, volunteer_phone: showPhone ? r.volunteer_phone : undefined };
});
```

### 修復要點

1. **新增網格建立者查詢** (第 112-124 行):
   - 收集所有志工報名涉及的網格 ID
   - 批次查詢這些網格的 `created_by_id`
   - 建立 `gridCreatorMap` 映射表以快速查詢

2. **完整的權限檢查** (第 147-153 行):
   - ✅ `canViewAllPhone`：管理員模式
   - ✅ `isSelf`：志工本人
   - ✅ `isGridCreator`：**網格建立者（新增）**

3. **效能優化**:
   - 使用 `IN` 查詢批次取得網格資訊
   - 避免在每個志工記錄上執行單獨查詢

## 測試建議

### 測試案例

1. **管理員測試**:
   - 登入為管理員
   - 訪問志工中心
   - ✅ 應該看到所有志工的電話

2. **網格建立者測試**:
   - 登入為一般使用者 A
   - 建立一個網格 G1
   - 使用者 B 在 G1 報名志工
   - 使用者 A 訪問志工中心
   - ✅ 應該看到使用者 B 在 G1 的電話
   - ❌ 不應該看到其他網格志工的電話

3. **志工本人測試**:
   - 登入為使用者 B
   - 在網格 G1 報名志工
   - 訪問志工中心
   - ✅ 應該看到自己的電話
   - ❌ 不應該看到其他志工的電話

4. **一般使用者測試**:
   - 登入為使用者 C（既非管理員，也非網格建立者，也非志工）
   - 訪問志工中心
   - ❌ 不應該看到任何志工的電話

## 影響範圍

### 修改檔案
- `packages/backend/src/routes/volunteers.ts`

### 相關功能
- 志工中心頁面 (`src/pages/Volunteers.jsx`)
- 志工列表 API (`/volunteers`)

### 資料庫查詢
- 新增一次批次查詢以取得網格建立者資訊
- 不影響資料庫結構

## 安全性考量

### 隱私保護
✅ 修復後符合隱私權限系統設計：
- 管理員可以管理所有志工資訊
- 網格建立者可以聯繫在自己網格報名的志工（地點關聯）
- 志工可以查看自己的資訊
- 其他人無法看到志工的聯絡資訊

### 資料洩漏風險
✅ 無資料洩漏風險：
- 權限檢查在後端 API 層執行
- 前端只能看到後端允許的資料
- 符合最小權限原則

## 結論

✅ **已完成修復**

修復後的程式碼：
1. ✅ 符合隱私權限系統設計
2. ✅ 與 `/volunteer-registrations` API 保持一致
3. ✅ 完整檢查三種權限：管理員、志工本人、網格建立者
4. ✅ 效能優化：批次查詢網格資訊
5. ✅ 程式碼清晰：明確註解權限檢查邏輯

### 修復位置
- **檔案**: `packages/backend/src/routes/volunteers.ts`
- **行數**: 112-156

### 建議後續動作
1. 重啟後端服務以套用變更
2. 執行上述測試案例驗證功能
3. 監控志工中心頁面的使用情況
