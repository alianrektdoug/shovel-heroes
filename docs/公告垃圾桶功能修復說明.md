# 公告垃圾桶功能修復說明

## 問題描述

移至垃圾桶功能失敗，錯誤訊息：
```
API PATCH /admin/announcements/:id/trash failed 500: {"message":"Failed to move announcement to trash"}
```

## 根本原因

**announcements 表缺少 `status` 欄位**

- 後端程式碼嘗試更新 `status` 欄位
- 但資料庫 announcements 表沒有這個欄位
- 導致 SQL 更新失敗

## 解決方案

### 1. 新增 status 欄位

執行遷移腳本：
```bash
cd packages/backend
npx tsx scripts/add-announcement-status.ts
```

### 2. 欄位詳情

- **欄位名稱**: `status`
- **資料類型**: `TEXT`
- **預設值**: `'active'`
- **NOT NULL**: 是
- **索引**: 已建立 `idx_announcements_status`

### 3. 允許的狀態值

- `'active'`: 啟用中（預設）
- `'deleted'`: 已移至垃圾桶

## 驗證步驟

### 1. 檢查欄位是否存在

```bash
cd packages/backend
npx tsx scripts/check-announcements-table.ts
```

應該會看到 `status` 欄位：
```
status: text NOT NULL DEFAULT 'active'::text
```

### 2. 測試移至垃圾桶功能

1. 啟動後端和前端應用
2. 登入管理後台
3. 進入「公告管理」
4. 選擇一則公告，點擊「刪除」（移至垃圾桶）
5. 確認公告從列表中消失

### 3. 檢查垃圾桶

1. 切換到「垃圾桶」標籤
2. 應該能看到剛才刪除的公告
3. 測試「還原」功能
4. 測試「永久刪除」功能

## 相關 API 端點

### 移至垃圾桶
```http
PATCH /admin/announcements/:announcementId/trash
```
- 權限要求: `trash_announcements` + `edit`
- 動作: 將 `status` 設為 `'deleted'`

### 從垃圾桶還原
```http
PATCH /admin/announcements/:announcementId/restore
```
- 權限要求: `trash_announcements` + `edit`
- 動作: 將 `status` 設為 `'active'`

### 永久刪除
```http
DELETE /admin/announcements/:announcementId
```
- 權限要求: `trash_announcements` + `delete`
- 動作: 從資料庫中永久刪除記錄

### 批次移至垃圾桶
```http
POST /admin/announcements/batch-trash
Body: { "announcementIds": ["id1", "id2", ...] }
```

### 批次永久刪除
```http
POST /admin/announcements/batch-delete
Body: { "announcementIds": ["id1", "id2", ...] }
```

## 檔案清單

### 新增的遷移腳本
- `packages/backend/scripts/add-announcement-status.ts` - 新增 status 欄位
- `packages/backend/scripts/check-announcements-table.ts` - 檢查表結構

### 相關後端程式碼
- `packages/backend/src/routes/admin.ts` (行 844-1060) - 公告垃圾桶相關路由

### 相關前端程式碼
- `src/components/admin/AnnouncementManagement.jsx` - 公告管理介面

## 權限設定

公告垃圾桶功能需要以下權限：

| 角色 | 檢視 | 編輯(還原) | 刪除(永久) |
|------|------|-----------|-----------|
| super_admin | ✅ | ✅ | ✅ |
| admin | ✅ | ✅ | ✅ |
| grid_manager | ✅ | ✅ | ❌ |
| user | ❌ | ❌ | ❌ |
| guest | ❌ | ❌ | ❌ |

可在「權限管理」頁面調整 `trash_announcements` 權限。

## 注意事項

1. **資料遷移**: 所有現有公告的 `status` 都會自動設為 `'active'`
2. **索引效能**: 已建立 `status` 索引，提升查詢效能
3. **向後兼容**: 不影響現有公告的正常顯示
4. **稽核日誌**: 所有垃圾桶操作都會記錄到稽核日誌

## 故障排除

### 問題：移至垃圾桶仍然失敗

檢查：
1. 確認 status 欄位已新增
2. 確認使用者有 `trash_announcements` 的 `edit` 權限
3. 查看後端 Console 的詳細錯誤訊息

### 問題：垃圾桶中看不到已刪除的公告

檢查：
1. 確認公告的 `status = 'deleted'`
2. 確認使用者有 `trash_announcements` 的 `view` 權限
3. 檢查前端是否正確過濾 status

### 問題：無法還原公告

檢查：
1. 確認使用者有 `trash_announcements` 的 `edit` 權限
2. 確認公告確實在垃圾桶中（`status = 'deleted'`）
3. 查看稽核日誌中的錯誤記錄

## 後續改進建議

1. **自動清理**: 定期清理超過 30 天的垃圾桶項目
2. **批次操作**: 優化批次刪除的 UI/UX
3. **確認對話框**: 永久刪除前顯示二次確認
4. **統計資訊**: 在垃圾桶頁面顯示項目數量和佔用空間
