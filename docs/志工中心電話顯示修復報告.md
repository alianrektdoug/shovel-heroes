# 志工中心電話顯示修復報告

## 問題描述

用戶報告：即使切換到超管、管理、網格管理員、一般用戶視角，志工管理中心的電話都顯示成「僅限管理員/相關格主查看電話」。

## 根因分析

### 問題 1: 後端權限檢查缺少 super_admin

**檔案**: `packages/backend/src/routes/volunteer-registrations.ts` 第 136 行

**問題**：確認志工報名時的權限檢查沒有包含 `super_admin` 角色

**修復**：已在角色檢查陣列中新增 `'super_admin'`

### 問題 2: 前端錯誤使用全域標記判斷電話顯示

**檔案**: `src/pages/Volunteers.jsx` 第 352 行

**問題根因**：

1. **後端邏輯**：
   - `/volunteers` API 在第 151-155 行已經根據權限正確過濾了電話資料
   - 管理員、網格建立者、志工本人可以看到電話
   - 其他人的 `volunteer_phone` 會是 `undefined`
   - 但全域的 `can_view_phone` 只在管理員模式時是 `true`

2. **前端邏輯錯誤**：
   - 第 111 行：`setCanViewPhone(canView)` 設定全域標記
   - 第 352 行：`canViewPhone && registration.volunteer_phone` 
   - 因為 `canViewPhone` 在非管理員時是 `false`，即使後端返回了電話也不會顯示

**修復前程式碼**：
```jsx
{canViewPhone && registration.volunteer_phone ? (
  <span>{registration.volunteer_phone}</span>
) : (
  <span className="text-gray-500 italic text-xs">僅限管理員/相關格主查看電話</span>
)}
```

**修復後程式碼**：
```jsx
{registration.volunteer_phone ? (
  <span>{registration.volunteer_phone}</span>
) : (
  <span className="text-gray-500 italic text-xs">僅限管理員/相關格主查看電話</span>
)}
```

**改變**：移除了 `canViewPhone &&` 條件，直接檢查 `registration.volunteer_phone` 是否存在

## 權限邏輯流程

### 後端處理 (volunteers.ts)

1. **檢查基礎權限** (第 54-65 行)：
   - 查詢 `role_permissions` 表
   - 檢查使用者是否有 `can_view` 權限

2. **資料範圍限制** (第 81-91 行)：
   - 管理員：可以看到所有志工
   - 一般使用者：只能看到自己的報名或自己管理的網格的志工

3. **取得網格建立者資訊** (第 112-124 行)：
   - 批次查詢所有相關網格的 `created_by_id`
   - 建立 `gridCreatorMap` 映射表

4. **逐行過濾電話** (第 147-155 行)：
   ```typescript
   const isGridCreator = gridCreatorMap[r.grid_id] === currentUserId;
   const isSelf = r.user_id && r.user_id === currentUserId;
   const showPhone = canViewAllPhone || isSelf || isGridCreator;
   
   return { ...base, volunteer_phone: showPhone ? r.volunteer_phone : undefined };
   ```

### 前端處理 (Volunteers.jsx)

1. **接收 API 資料** (第 74-95 行)：
   - 接收 `/volunteers` API 回應
   - 提取 `data` 陣列和 `can_view_phone` 標記

2. **顯示電話** (第 352 行)：
   - ~~錯誤：檢查 `canViewPhone && registration.volunteer_phone`~~
   - **正確**：直接檢查 `registration.volunteer_phone`
   - 後端已經根據權限過濾，前端只需要顯示即可

## 修復摘要

### 修改檔案

1. **packages/backend/src/routes/volunteer-registrations.ts** 第 136 行
   - 新增 `'super_admin'` 到權限檢查陣列

2. **src/pages/Volunteers.jsx** 第 352 行
   - 移除 `canViewPhone &&` 條件判斷

### 權限矩陣（修復後）

| 角色 | 看到的電話 |
|------|-----------|
| super_admin | ✅ 所有志工的電話 |
| admin | ✅ 所有志工的電話 |
| grid_manager | ✅ 自己管理的網格中的志工電話 |
| 網格建立者 | ✅ 自己建立的網格中的志工電話 |
| 志工本人 | ✅ 自己的電話 |
| 其他用戶 | ❌ 看不到電話 |

## 測試計畫

### 測試案例 1: 超級管理員
1. 以 super_admin 身分登入
2. 進入志工中心
3. ✅ 預期：可以看到所有志工的電話號碼
4. 點擊「確認報名」
5. ✅ 預期：成功確認（不再出現 403 錯誤）

### 測試案例 2: 管理員
1. 以 admin 身分登入
2. 進入志工中心
3. ✅ 預期：可以看到所有志工的電話號碼

### 測試案例 3: 網格建立者
1. 以 user A 身分登入
2. 建立網格 G1
3. 以 user B 身分在 G1 報名志工（填寫電話 0912345678）
4. 切換回 user A
5. 進入志工中心
6. ✅ 預期：可以看到 user B 在 G1 的電話 0912345678
7. ❌ 預期：看不到其他網格志工的電話

### 測試案例 4: 志工本人
1. 以 user B 身分登入
2. 在網格 G1 報名志工（填寫電話 0987654321）
3. 進入志工中心
4. ✅ 預期：可以看到自己的電話 0987654321
5. ❌ 預期：看不到其他志工的電話

### 測試案例 5: 一般使用者
1. 以 user C 身分登入（非管理員、非網格建立者、非志工）
2. 進入志工中心
3. ❌ 預期：所有志工的電話都顯示「僅限管理員/相關格主查看電話」

## 驗證步驟

修復後請執行以下檢查：

1. **清除快取**：
   - 刷新前端頁面（Ctrl+F5）
   - 或使用無痕模式

2. **檢查 API 回應**：
   - 打開瀏覽器開發者工具 (F12)
   - 切換到 Network 標籤
   - 進入志工中心頁面
   - 查看 `/volunteers` API 請求
   - 檢查 response 中的 `data` 陣列
   - 確認有權限的志工記錄包含 `volunteer_phone` 欄位

3. **檢查電話顯示**：
   - 切換不同角色視角
   - 驗證電話顯示符合權限矩陣

## 技術細節

### 為什麼不使用全域 can_view_phone 標記？

**原因**：不同志工的電話顯示權限是**逐行計算**的，不能用一個全域標記來判斷。

**例如**：
- 使用者 A 建立了網格 G1 和 G2
- 志工 B 在 G1 報名
- 志工 C 在 G2 報名  
- 志工 D 在 G3 報名（G3 由使用者 E 建立）

使用者 A 應該：
- ✅ 看到 B 的電話（G1 的建立者）
- ✅ 看到 C 的電話（G2 的建立者）
- ❌ 看不到 D 的電話（非 G3 的建立者）

這種情況下，無法用一個全域的 `can_view_phone` 來判斷，必須逐行檢查。

### 後端已做的權限過濾

後端在 `volunteers.ts` 第 151-155 行已經做了完整的權限檢查：

```typescript
const isGridCreator = gridCreatorMap[r.grid_id] === currentUserId;
const isSelf = r.user_id && r.user_id === currentUserId;
const showPhone = canViewAllPhone || isSelf || isGridCreator;

return { ...base, volunteer_phone: showPhone ? r.volunteer_phone : undefined };
```

如果使用者沒有權限，`volunteer_phone` 會是 `undefined`，前端不需要再次判斷。

## 結論

✅ **修復完成**

兩個問題都已修復：
1. 403 錯誤：已新增 `super_admin` 到權限檢查
2. 電話不顯示：已移除前端的錯誤判斷邏輯

修復後的邏輯更簡潔：
- 後端根據權限過濾電話資料
- 前端直接顯示後端返回的資料
- 符合單一職責原則和信任後端的設計模式
