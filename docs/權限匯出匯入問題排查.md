# 權限匯出匯入問題排查指南

## 問題描述

匯出的資料不是資料庫內設定的權限資料。

## 已驗證的功能

✅ **後端查詢功能正常**
- 執行 `check-permissions.ts` 確認資料庫有 64 筆權限資料
- 執行 `test-export.ts` 確認後端可以正確產生 CSV

✅ **後端 API 正常**
- 路由：`GET /api/permissions/export`
- 權限檢查：`requireManagePermission('role_permissions')`
- 查詢語句：從 `role_permissions` 表查詢所有資料
- CSV 格式：正確，包含 UTF-8 BOM

## 可能的問題原因

### 1. 權限不足

**症狀**：匯出按鈕無反應或回傳錯誤

**檢查方法**：
```javascript
// 開啟瀏覽器開發者工具 Console
// 檢查是否有權限錯誤訊息
```

**解決方案**：
1. 確認登入的使用者是 `super_admin` 角色
2. 確認該使用者的 `role_permissions` 權限設定：
   - `can_manage = 1`

### 2. API 請求失敗

**症狀**：瀏覽器 Console 顯示網路錯誤

**檢查方法**：
```javascript
// 開啟瀏覽器開發者工具 Network 標籤
// 點擊匯出按鈕
// 查看 /api/permissions/export 請求
// 檢查回應狀態碼和內容
```

**可能的錯誤**：
- 401: 未授權（token 失效）
- 403: 權限不足
- 500: 伺服器錯誤

### 3. CSV 下載問題

**症狀**：下載的 CSV 檔案是空的或格式錯誤

**檢查方法**：
```javascript
// 在 src/api/permissions.js 的 exportPermissions 函數中加入 console.log
export async function exportPermissions() {
  const response = await fetch('/api/permissions/export', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    }
  });

  console.log('Response status:', response.status);
  console.log('Response headers:', response.headers);

  if (!response.ok) {
    const error = await response.json();
    console.error('Export error:', error);
    throw new Error(error.message || '匯出失敗');
  }

  const blob = await response.blob();
  console.log('Blob size:', blob.size);
  console.log('Blob type:', blob.type);

  // ... 其餘程式碼
}
```

### 4. 快取問題

**症狀**：匯出的資料是舊的

**解決方案**：
1. 清除瀏覽器快取
2. 硬性重新整理（Ctrl+Shift+R 或 Cmd+Shift+R）
3. 重新啟動後端伺服器

## 測試步驟

### 步驟 1: 驗證資料庫資料

```bash
cd packages/backend
npx tsx scripts/check-permissions.ts
```

**預期結果**：顯示所有角色的權限資料統計

### 步驟 2: 測試後端匯出功能

```bash
cd packages/backend
npx tsx scripts/test-export.ts
```

**預期結果**：
- 產生 `test-permissions-export-YYYY-MM-DD.csv` 檔案
- 檔案包含完整的權限資料
- 使用 Excel 開啟可以正常顯示中文

### 步驟 3: 測試前端匯出功能

1. 確保後端伺服器正在運行
2. 以 `super_admin` 角色登入
3. 進入「管理後台」→「權限管理」
4. 開啟瀏覽器開發者工具（F12）
5. 切換到 Network 標籤
6. 點擊「匯出」按鈕
7. 檢查：
   - Network 標籤中的 `/api/permissions/export` 請求
   - 回應狀態碼應為 200
   - 回應類型應為 `text/csv`
   - 下載的 CSV 檔案應包含所有權限資料

### 步驟 4: 驗證 CSV 內容

開啟下載的 CSV 檔案，檢查：
- ✅ 第一行是標題行
- ✅ 資料行數與資料庫筆數相符（應為 64 筆 + 1 標題行 = 65 行）
- ✅ 中文顯示正常
- ✅ 資料內容與資料庫一致

## 除錯工具

### 1. 瀏覽器 Console 除錯

```javascript
// 在瀏覽器 Console 中執行
// 檢查當前使用者的權限
const token = localStorage.getItem('token');
console.log('Token:', token);

// 手動呼叫匯出 API
fetch('/api/permissions/export', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(response => {
  console.log('Status:', response.status);
  return response.text();
})
.then(text => {
  console.log('CSV length:', text.length);
  console.log('First 500 chars:', text.substring(0, 500));
})
.catch(error => {
  console.error('Error:', error);
});
```

### 2. 檢查權限設定

```sql
-- 在資料庫中執行
SELECT role, permission_key, can_manage
FROM role_permissions
WHERE permission_key = 'role_permissions'
ORDER BY role;
```

**預期結果**：
- super_admin: can_manage = 1
- admin: can_manage = 0
- 其他角色: can_manage = 0

## 常見問題 FAQ

### Q1: 為什麼我看不到匯出按鈕？

**A**: 檢查：
1. 是否在「權限管理」頁面
2. 瀏覽器視窗寬度是否足夠（按鈕可能被隱藏）
3. 權限管理元件是否正確載入

### Q2: 點擊匯出按鈕沒有反應

**A**: 檢查：
1. 瀏覽器 Console 是否有錯誤訊息
2. Network 標籤是否有 API 請求
3. 是否有權限（super_admin 或有 can_manage 權限）

### Q3: 下載的 CSV 檔案是空的

**A**: 檢查：
1. Network 標籤中 API 回應的大小
2. 後端是否正常運行
3. 資料庫連線是否正常

### Q4: CSV 中文亂碼

**A**:
- 後端已加入 UTF-8 BOM，使用 Excel 開啟應該正常
- 如果仍有問題，使用記事本或 VSCode 開啟查看編碼

## 修正建議

如果問題持續存在，可以：

1. **增強錯誤訊息**：在前端加入更詳細的錯誤提示
2. **加入載入狀態**：顯示「匯出中...」提示
3. **驗證檔案內容**：下載後自動檢查檔案大小

## 聯絡支援

如果以上方法都無法解決問題，請提供：
1. 瀏覽器 Console 的錯誤訊息
2. Network 標籤的 API 請求截圖
3. 下載的 CSV 檔案內容（前 20 行）
4. 使用者角色和權限設定
