# 物資 CSV 匯入問題診斷報告

## 問題描述
用戶反映物資管理的「匯出 CSV」→「匯入 CSV」功能失敗，顯示「匯入失敗：沒有成功匯入任何資料」。

## CSV 檔案內容分析

從 `csv/supplies_export_2025-10-04 (1).csv` 檔案中看到：

```csv
ID,網格代碼,災區,物資名稱,數量,單位,捐贈者姓名,聯絡電話,Email,配送方式,送達地址,預計送達時間,備註,狀態,捐贈時間
a066395c-9578-4968-874f-30eee4cbae39,武昌街276號,匯入未知災區 a931d7,鋤頭,1,枝,alian,1111,,direct,111,111,,pledged,2025-10-04 22:36:53
9931d062-d51e-40dd-aadd-ec7ae5d62f58,中學街75巷1弄5號,匯入未知災區 a931d7,鋤頭,5,枝,測試捐贈者 - 張小明,0987654321,test@example.com,delivery,台北市大安區測試路123號,今日下午 3:00,這是一筆測試捐贈記錄，包含完整的配送資訊,pledged,2025-10-04 21:40:27
```

## 測試結果

### 1. CSV 解析測試 ✅
- CSV 可以正確解析
- 欄位名稱匹配正確
- 必填欄位都有值

### 2. 網格查找測試 ✅
- 網格代碼「武昌街276號」可以在資料庫中找到
- 網格代碼「中學街75巷1弄5號」可以在資料庫中找到

### 3. 匯入邏輯測試 ✅
後端匯入邏輯（csv.ts:700-755）檢查正常：
- 支援兩種欄位格式（範本格式和匯出格式）
- 必填欄位驗證正確
- 網格查找邏輯正確

## 可能的問題原因

### 原因 1：前端權限問題
匯入功能需要 `supplies` 的 `manage` 權限。如果用戶沒有此權限，API 會返回 401 Unauthorized。

**檢查方法**：
1. 打開瀏覽器開發者工具（F12）
2. 切換到 Network 標籤
3. 執行匯入操作
4. 查看 `/csv/import/supplies` 請求的狀態碼和回應

### 原因 2：伺服器錯誤
如果後端處理過程中出現錯誤，會返回 500 錯誤。

**檢查方法**：
1. 查看後端日誌
2. 檢查錯誤訊息

### 原因 3：空的 Email 欄位處理
CSV 中第一筆記錄的 Email 欄位為空（``），可能導致問題。

**目前邏輯**：
```javascript
const donorEmail = record['Email'] || '';
```

這個處理是正確的，空字串會被正確處理。

## 建議的診斷步驟

### 步驟 1：檢查用戶權限
確認登入用戶具有 `supplies:manage` 權限。

### 步驟 2：查看瀏覽器控制台
1. 打開瀏覽器開發者工具（F12）
2. 切換到 Console 標籤
3. 執行匯入操作
4. 查看是否有錯誤訊息

### 步驟 3：查看網路請求
1. 打開瀏覽器開發者工具（F12）
2. 切換到 Network 標籤
3. 執行匯入操作
4. 找到 `/csv/import/supplies` 請求
5. 查看：
   - 狀態碼（應該是 200）
   - 請求 Body（CSV 內容）
   - 回應 Body（imported, skipped, errors）

### 步驟 4：檢查後端日誌
如果使用 `npm run dev` 啟動後端，檢查終端機的日誌輸出。

## 修復建議

如果問題是因為空的 Email 欄位，可以考慮以下修復：

### 選項 1：匯出時填入預設值
修改匯出邏輯，將空的 Email 填入預設值（如 "未提供"）。

### 選項 2：匯入時更好的錯誤處理
在匯入邏輯中添加更詳細的錯誤訊息，指出具體是哪一筆記錄的哪個欄位有問題。

### 選項 3：前端顯示詳細錯誤
修改前端代碼，在匯入失敗時顯示具體的錯誤訊息列表。

## 當前狀態

後端代碼已檢查，匯入邏輯正常。建議用戶：
1. 檢查瀏覽器控制台的錯誤訊息
2. 確認是否有相應的權限
3. 提供具體的錯誤訊息以便進一步診斷

## 下一步行動

請用戶提供：
1. 瀏覽器控制台的截圖（包含錯誤訊息）
2. Network 標籤中 `/csv/import/supplies` 請求的詳細資訊
3. 當前登入用戶的角色和權限
