# 隱私權限系統 - 舊資料處理說明

## 問題描述

在實作基於地點關聯的隱私權限系統時，發現資料庫中存在一些沒有 `created_by_id` 的舊資料：

### 檢查結果

```
📈 統計：
  總數: 16
  有 created_by_id: 0 (0%)
  無 created_by_id: 16 (100%)
```

## 影響

### 物資捐贈表 (supply_donations)

缺少 `created_by_id` 的捐贈記錄會導致：
1. ❌ 捐贈者本人無法被正確識別
2. ❌ 捐贈者本人看不到自己的聯絡資訊（會被過濾掉）
3. ✅ 網格建立者和管理員仍然可以看到聯絡資訊（基於網格關聯）

### 志工報名表 (volunteer_registrations)

需要檢查是否也有類似問題。

## 解決方案

### 方案 1：清理無效資料（推薦）

由於這些舊資料沒有捐贈者資訊，且數量不多（16筆），建議直接清理：

```sql
-- 刪除沒有捐贈者資訊的記錄
DELETE FROM supply_donations
WHERE donor_name IS NULL
  AND donor_phone IS NULL
  AND donor_email IS NULL
  AND created_by_id IS NULL;
```

執行腳本：
```bash
cd packages/backend
npx tsx scripts/clean-invalid-donations.ts
```

### 方案 2：保留資料但標記

如果需要保留這些記錄作為測試資料：

```sql
-- 更新為測試資料標記
UPDATE supply_donations
SET notes = COALESCE(notes || ' ', '') || '[測試資料]'
WHERE created_by_id IS NULL
  AND donor_name IS NULL;
```

## 新資料處理

### 確保新創建的捐贈正確儲存 created_by_id

檢查 `packages/backend/src/routes/supply-donations.ts:109`：

```typescript
created_by_id: req.user?.id || null,  // ✅ 正確儲存
created_by: req.user?.name || null
```

### 測試新捐贈

1. 以使用者身份登入
2. 在地圖上選擇一個網格
3. 新增物資捐贈
4. 檢查資料庫：

```sql
SELECT id, supply_name, donor_name, created_by_id, created_by
FROM supply_donations
WHERE created_by_id IS NOT NULL
ORDER BY created_at DESC
LIMIT 5;
```

## 驗證隱私過濾

### 測試場景

1. **情境 A：捐贈者查看自己的捐贈**
   - 使用者 A 登入
   - A 建立了物資捐贈
   - A 應該能看到自己的聯絡資訊

2. **情境 B：網格建立者查看捐贈**
   - 使用者 A 建立網格 G1
   - 使用者 B 在 G1 捐贈物資
   - A 應該能看到 B 的聯絡資訊（因為 B 捐贈給 A 的網格）

3. **情境 C：其他人查看捐贈**
   - 使用者 A 建立網格 G1
   - 使用者 B 在 G1 捐贈物資
   - 使用者 C 不應該看到 B 的聯絡資訊

### 檢查腳本

```bash
cd packages/backend
npx tsx scripts/check-donations-created-by.ts
```

## 後續改進

### 1. 前端驗證

在創建捐贈時，確保前端正確傳遞使用者資訊：

```javascript
// src/api/supplies.js
export async function createSupplyDonation(data) {
  // ✅ 後端會自動從 req.user 獲取 created_by_id
  return http.post('/supply-donations', data);
}
```

### 2. 資料庫約束

考慮是否要將 `created_by_id` 設為必填（NOT NULL）：

```sql
-- 謹慎：這會阻止匿名捐贈
ALTER TABLE supply_donations
ALTER COLUMN created_by_id SET NOT NULL;
```

**注意**：如果系統支援匿名捐贈，則不應設為 NOT NULL。

### 3. 監控

定期檢查是否有新的無效資料：

```sql
SELECT COUNT(*)
FROM supply_donations
WHERE created_by_id IS NULL
  AND created_at > NOW() - INTERVAL '7 days';
```

## 總結

✅ **短期處理**：清理無效舊資料
✅ **長期保障**：新資料正確儲存 created_by_id
✅ **隱私保護**：隱私過濾邏輯正確運作
⚠️ **注意事項**：舊資料的捐贈者無法被識別，建議清理
