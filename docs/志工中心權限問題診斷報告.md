# 志工中心權限問題診斷報告

## 專業技術報告 (Professional Technical Report)

### 執行摘要 (Executive Summary)

志工中心模組存在嚴重的權限控制缺陷，導致不同角色切換時頁面無差異。主要問題集中在三個層面：
1. **權限配置錯誤** - 訪客角色擁有過高權限，網格管理員權限不足
2. **資料完整性缺失** - 關鍵欄位資料為空值或空字串
3. **業務邏輯缺陷** - 電話顯示邏輯依賴不存在的資料關聯

### 詳細分析 (Detailed Analysis)

#### 1. 權限設定問題分析

**現況：**
```sql
-- 資料庫權限設定 (role_permissions table)
[guest] volunteers: can_view=1, can_manage=0     -- 訪客可查看
[user] volunteers: can_view=1, can_manage=0       -- 一般使用者無管理權限
[grid_manager] volunteers: can_view=1, can_manage=0  -- 網格管理員無管理權限！
[admin] volunteers: can_view=1, can_manage=1      -- 管理員有管理權限
[super_admin] volunteers: can_view=1, can_manage=1   -- 超級管理員有管理權限
```

**問題根因：**
- 第39行 `006-role-permissions.sql`：訪客被授予 `can_view=1` 權限
- 第81行 `006-role-permissions.sql`：網格管理員僅設定 `can_create=1, can_edit=1`，但缺少 `can_manage=1`
- 後端 `volunteers.ts` 第83行：`isAdminMode = hasManagePermission`，導致網格管理員無法進入管理模式

#### 2. 資料完整性問題

**資料庫結構分析：**
```sql
CREATE TABLE volunteer_registrations (
  user_id TEXT REFERENCES users(id) ON DELETE SET NULL,  -- 可為空
  volunteer_phone TEXT,                                  -- 可為空
  volunteer_email TEXT,                                  -- 可為空
  created_by_id TEXT,                                    -- 未設外鍵約束
  ...
)
```

**實際資料狀態：**
- `volunteer_phone`: 所有記錄為空字串 `""`（非 NULL）
- `user_id`: 所有記錄為 NULL（無使用者關聯）
- `grid.created_by_id`: 所有記錄為 NULL
- `grid.grid_manager_id`: 所有記錄為 NULL

#### 3. 業務邏輯缺陷分析

**後端邏輯 (`volunteers.ts`)：**

```javascript
// 第128行：電話顯示權限判斷
const canViewAllPhone = isAdminMode;  // 只有 admin/super_admin 為 true

// 第147-153行：個別記錄電話顯示邏輯
const isGridCreator = gridCreatorMap[r.grid_id] === currentUserId;  // 永遠為 false (created_by_id 都是 null)
const isSelf = r.user_id && r.user_id === currentUserId;  // 永遠為 false (user_id 都是 null)
const showPhone = canViewAllPhone || isSelf || isGridCreator;  // 只有管理員為 true
```

**前端邏輯 (`Volunteers.jsx`)：**
```javascript
// 第209-216行：前端權限檢查
if (!user || actingRole === 'guest') {
  return <UnauthorizedAccess />;  // 應該攔截訪客，但後端允許訪客查看
}

// 第352-356行：電話顯示邏輯
{registration.volunteer_phone ? (
  <span>{registration.volunteer_phone}</span>
) : (
  <span className="text-gray-500 italic text-xs">僅限管理員/相關格主查看電話</span>
)}
```

### 關鍵發現 (Key Findings)

1. **權限配置矛盾**
   - 前端攔截訪客，但後端允許訪客查看資料
   - 網格管理員理應能管理志工，但 `can_manage=0` 導致權限不足

2. **資料關聯斷裂**
   - 志工報名未關聯使用者（`user_id=NULL`）
   - 網格無管理者資訊（`created_by_id=NULL`, `grid_manager_id=NULL`）
   - 電話資料為空字串而非 NULL，影響顯示邏輯

3. **業務邏輯失效**
   - 「志工本人查看自己電話」功能失效（無 user_id 關聯）
   - 「網格建立者查看志工電話」功能失效（無 created_by_id）
   - 只剩下管理員模式可正常運作

### 風險評估 (Risk Assessment)

| 風險項目 | 嚴重程度 | 影響範圍 | 緊急程度 |
|---------|---------|---------|---------|
| 訪客可查看志工資料 | **高** | 資料隱私外洩 | **立即** |
| 網格管理員無法管理志工 | **中** | 功能失效 | **高** |
| 電話資訊無法顯示 | **中** | 使用者體驗 | **中** |
| 資料關聯缺失 | **高** | 系統完整性 | **高** |

### 建議事項 (Recommendations)

#### 立即修復（Priority 1）
1. **修正訪客權限**
   ```sql
   UPDATE role_permissions
   SET can_view = 0
   WHERE role = 'guest' AND permission_key = 'volunteers';
   ```

2. **修正網格管理員權限**
   ```sql
   UPDATE role_permissions
   SET can_manage = 1
   WHERE role = 'grid_manager' AND permission_key = 'volunteers';
   ```

#### 短期改善（Priority 2）
1. **建立資料關聯**
   - 將現有志工報名關聯到對應使用者
   - 設定網格的 `created_by_id` 和 `grid_manager_id`
   - 將空字串電話改為 NULL 或填入實際資料

2. **優化權限邏輯**
   - 網格管理員應能查看其管理網格的志工電話
   - 新增 `grid_managers` 關聯表以支援多管理員

#### 長期優化（Priority 3）
1. **資料庫結構優化**
   - 新增外鍵約束確保資料完整性
   - 建立觸發器自動維護 `created_by_id`
   - 實作軟刪除機制

2. **權限系統重構**
   - 實作基於資源的存取控制（RBAC）
   - 新增權限繼承機制
   - 建立權限快取層提升效能

---

## 簡明說明 (Simplified Explanation)

### 問題簡述
志工中心就像一個資訊看板，現在的問題是：
- **訪客也能看** - 原本只有會員能看的資訊，現在路人也看得到
- **管理員權限不足** - 網格管理員就像區長，應該能管理區內志工，但現在沒有權限
- **電話看不到** - 系統找不到電話號碼的主人，所以都顯示不出來

### 影響說明
1. **隱私問題** - 志工的個人資訊可能被未授權人員看到
2. **管理困難** - 網格管理員無法有效協調志工
3. **聯繫不便** - 看不到電話號碼，無法聯繫志工

### 修復步驟（依序執行）

#### 第一步：緊急修復權限（5分鐘）
```sql
-- 1. 阻止訪客查看志工資料
UPDATE role_permissions SET can_view = 0
WHERE role = 'guest' AND permission_key = 'volunteers';

-- 2. 給予網格管理員管理權限
UPDATE role_permissions SET can_manage = 1
WHERE role = 'grid_manager' AND permission_key = 'volunteers';
```

#### 第二步：修復資料關聯（30分鐘）
```sql
-- 1. 關聯志工報名與使用者（需要根據實際情況調整）
UPDATE volunteer_registrations vr
SET user_id = u.id
FROM users u
WHERE vr.volunteer_email = u.email AND vr.user_id IS NULL;

-- 2. 設定網格管理員（需要根據實際情況調整）
UPDATE grids SET created_by_id = [適當的使用者ID] WHERE created_by_id IS NULL;

-- 3. 修復空字串電話號碼
UPDATE volunteer_registrations
SET volunteer_phone = NULL
WHERE volunteer_phone = '';
```

#### 第三步：驗證修復（10分鐘）
1. 使用訪客身份訪問志工中心，應該看到「無權限」提示
2. 使用網格管理員身份，應該能看到志工電話
3. 使用一般使用者身份，應該只能看到自己的報名資訊

### 預防措施
1. **定期權限審查** - 每月檢查一次權限設定
2. **資料完整性檢查** - 建立自動化檢查腳本
3. **測試案例** - 為每個角色建立完整測試

### 技術指標 (Technical Metrics)

| 指標項目 | 修復前 | 修復後目標 |
|---------|--------|------------|
| 訪客可見志工數 | 全部 | 0 |
| 網格管理員可管理 | 否 | 是 |
| 電話顯示率 | <5% | >90% |
| 資料關聯完整性 | <10% | >95% |

---

## 測試驗證方案

### 單元測試
```javascript
describe('志工權限測試', () => {
  test('訪客無法查看志工列表', async () => {
    const response = await request.get('/volunteers')
      .set('X-Acting-Role', 'guest');
    expect(response.status).toBe(403);
  });

  test('網格管理員可以查看電話', async () => {
    const response = await request.get('/volunteers')
      .set('X-Acting-Role', 'grid_manager')
      .set('Authorization', 'Bearer valid-token');
    expect(response.body.can_view_phone).toBe(true);
  });

  test('一般使用者只能看到自己的報名', async () => {
    const response = await request.get('/volunteers')
      .set('X-Acting-Role', 'user')
      .set('Authorization', 'Bearer user-token');
    response.body.data.forEach(item => {
      expect(item.user_id).toBe(userId);
    });
  });
});
```

### 整合測試檢查清單
- [ ] 訪客身份：應該返回 403 Forbidden
- [ ] 一般使用者：只能看到自己的報名
- [ ] 網格管理員：可以管理所屬網格的志工
- [ ] 管理員：可以查看所有志工電話
- [ ] 超級管理員：擁有完整權限

### 資料驗證 SQL
```sql
-- 檢查權限設定
SELECT role, permission_key, can_view, can_manage
FROM role_permissions
WHERE permission_key = 'volunteers'
ORDER BY role;

-- 檢查資料完整性
SELECT
  COUNT(*) as total,
  COUNT(user_id) as with_user,
  COUNT(NULLIF(volunteer_phone, '')) as with_phone
FROM volunteer_registrations;

-- 檢查網格管理員
SELECT
  COUNT(*) as total_grids,
  COUNT(created_by_id) as with_creator,
  COUNT(grid_manager_id) as with_manager
FROM grids;

-- 檢查電話號碼空字串問題
SELECT
  COUNT(*) as total_registrations,
  SUM(CASE WHEN volunteer_phone = '' THEN 1 ELSE 0 END) as empty_string_phones,
  SUM(CASE WHEN volunteer_phone IS NULL THEN 1 ELSE 0 END) as null_phones,
  SUM(CASE WHEN volunteer_phone != '' AND volunteer_phone IS NOT NULL THEN 1 ELSE 0 END) as valid_phones
FROM volunteer_registrations;
```

---

## 實作修復腳本

### 完整修復腳本 (fix-volunteer-permissions.sql)
```sql
-- 1. 修正權限設定
BEGIN;

-- 修正訪客權限（不應該能查看志工）
UPDATE role_permissions
SET can_view = 0, updated_at = NOW()
WHERE role = 'guest' AND permission_key = 'volunteers';

-- 修正網格管理員權限（應該要有管理權限）
UPDATE role_permissions
SET can_manage = 1, updated_at = NOW()
WHERE role = 'grid_manager' AND permission_key = 'volunteers';

-- 2. 修復資料關聯
-- 關聯志工報名與使用者（透過 email）
UPDATE volunteer_registrations vr
SET user_id = u.id
FROM users u
WHERE vr.volunteer_email = u.email
  AND vr.user_id IS NULL
  AND vr.volunteer_email IS NOT NULL
  AND vr.volunteer_email != '';

-- 修復空字串電話號碼為 NULL
UPDATE volunteer_registrations
SET volunteer_phone = NULL
WHERE volunteer_phone = '';

-- 3. 設定網格建立者（如果有明確的第一個管理員）
UPDATE grids g
SET created_by_id = u.id
FROM users u
WHERE u.role IN ('admin', 'super_admin')
  AND g.created_by_id IS NULL
  AND NOT EXISTS (
    SELECT 1 FROM grids g2
    WHERE g2.created_by_id = u.id
  )
LIMIT 1;

COMMIT;

-- 驗證修復結果
SELECT 'Permission Check' as check_type,
       role,
       can_view,
       can_manage
FROM role_permissions
WHERE permission_key = 'volunteers'
ORDER BY role;

SELECT 'Data Integrity Check' as check_type,
       COUNT(*) as total_registrations,
       COUNT(user_id) as with_user_id,
       COUNT(NULLIF(volunteer_phone, '')) as with_valid_phone
FROM volunteer_registrations;
```

---

## 結論

志工中心的權限問題源於三個層面的缺陷：權限配置錯誤、資料完整性缺失、業務邏輯依賴斷裂的資料關聯。透過本報告提供的修復方案，可以在短時間內解決緊急問題，並建立長期的改善機制。

### 關鍵行動項目
1. **立即執行**：修正權限設定（5分鐘）
2. **今日完成**：修復資料關聯（30分鐘）
3. **本週完成**：建立測試案例並執行完整測試
4. **本月完成**：實作長期優化方案

建議依照優先順序執行修復，並在每個步驟後進行充分測試驗證。

**報告完成時間：** 2025-10-05
**報告版本：** v2.0
**建議覆核人員：** 系統管理員、資安人員、專案經理

---

### 附錄：相關檔案清單

- 後端邏輯：`packages/backend/src/routes/volunteers.ts`
- 前端頁面：`src/pages/Volunteers.jsx`
- 權限設定：`packages/backend/src/lib/migrations/006-role-permissions.sql`
- 資料庫初始化：`packages/backend/src/lib/db-init.ts`
- 志工報名路由：`packages/backend/src/routes/volunteer-registrations.ts`