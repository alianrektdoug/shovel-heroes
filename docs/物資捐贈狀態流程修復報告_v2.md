# 物資捐贈狀態流程修復報告 v2

## 修復日期
2025-10-05 上午 3:52

## 問題描述

使用者回報物資捐贈狀態更新失敗，錯誤訊息：
```
Supplies.jsx:118 Failed to update donation status to in_transit:
Error: API PUT /supply-donations/bea9d6a4-1163-44b2-826d-db8f4b9a711d failed 400:
{"message":"Invalid or missing status"}
```

**原因**：後端程式碼回退到舊版本，缺少 `in_transit` 狀態支援

## 使用者需求（權限邏輯）

根據使用者澄清，物資捐贈的權限規則應為：

### 捐贈者本人 (Donor)
可以執行以下操作：
- ✅ 確認捐贈 (`pledged` → `confirmed`)
- ✅ 取消捐贈 (`pledged/confirmed/in_transit` → `cancelled`)
- ✅ 標記運送中 (`confirmed` → `in_transit`)
- ✅ 標記到達 (`in_transit` → `delivered`)

### 網格建立者/管理員 (Grid Owner)
可以執行以下操作：
- ✅ 確認最終收到 (`delivered` → `received`)
- ✅ 取消捐贈 (任何階段 → `cancelled`)

### 管理員 (Admin/Super Admin)
- ✅ 可以執行所有狀態更新操作

## 修復內容

### 1. 更新允許的狀態列表

**檔案**: `packages/backend/src/routes/supply-donations.ts:128`

```typescript
// 修復前
const allowed = ['pledged', 'confirmed', 'delivered', 'received', 'cancelled'];

// 修復後
const allowed = ['pledged', 'confirmed', 'in_transit', 'delivered', 'received', 'cancelled'];
```

### 2. 更新狀態轉換規則

**檔案**: `packages/backend/src/routes/supply-donations.ts:152-159`

```typescript
// 修復後的狀態轉換規則
function canTransition(from: string, to: string) {
  if (from === to) return true;
  if (from === 'pledged') return ['confirmed', 'cancelled'].includes(to);
  if (from === 'confirmed') return ['in_transit', 'cancelled'].includes(to);
  if (from === 'in_transit') return ['delivered', 'cancelled'].includes(to);
  if (from === 'delivered') return ['received'].includes(to);
  return false; // received and cancelled are terminal
}
```

### 3. 更新權限規則

**檔案**: `packages/backend/src/routes/supply-donations.ts:165-184`

```typescript
// 權限規則
// 捐贈者本人 (Donor): 可以確認捐贈、取消、標記運送中、標記到達
// 網格建立者/管理員 (Grid Owner): 可以確認最終收到
// 管理員 (Admin): 可以進行所有操作
if (status === 'cancelled') {
  // 捐贈者或網格人員或管理員都可以取消
  if (!(isDonorSelf || isPrivileged)) {
    return reply.status(403).send({ message: 'Forbidden - Only donor or grid owner can cancel' });
  }
} else if (['confirmed', 'in_transit', 'delivered'].includes(status)) {
  // 捐贈者本人或管理員可以確認、標記運送中、標記到達
  if (!(isDonorSelf || isAdmin)) {
    return reply.status(403).send({ message: 'Forbidden - Only donor or admin can update to this status' });
  }
} else if (status === 'received') {
  // 只有網格建立者/管理員或超級管理員可以確認收到
  if (!isPrivileged) {
    return reply.status(403).send({ message: 'Forbidden - Only grid owner or admin can confirm received' });
  }
}
```

## 完整狀態流程

### 正常流程
```
已承諾(pledged)
  → 已確認(confirmed)        [捐贈者本人或管理員]
  → 運送中(in_transit)       [捐贈者本人或管理員]
  → 已送達(delivered)        [捐贈者本人或管理員]
  → 已收到(received)         [網格建立者/管理員或超級管理員]
```

### 取消流程
```
已承諾(pledged) → 已取消(cancelled)      [捐贈者或網格人員或管理員]
已確認(confirmed) → 已取消(cancelled)    [捐贈者或網格人員或管理員]
運送中(in_transit) → 已取消(cancelled)   [捐贈者或網格人員或管理員]
```

### 終止狀態
- `received`（已收到）- 無法再轉換
- `cancelled`（已取消）- 無法再轉換
- `delivered`（已送達）- 只能轉換到 `received`

## 權限矩陣

| 狀態轉換 | 捐贈者本人 | 網格建立者/管理員 | 管理員 |
|---------|----------|----------------|--------|
| pledged → confirmed | ✅ | ❌ | ✅ |
| pledged → cancelled | ✅ | ✅ | ✅ |
| confirmed → in_transit | ✅ | ❌ | ✅ |
| confirmed → cancelled | ✅ | ✅ | ✅ |
| in_transit → delivered | ✅ | ❌ | ✅ |
| in_transit → cancelled | ✅ | ✅ | ✅ |
| delivered → received | ❌ | ✅ | ✅ |

## 權限變數定義

```typescript
const isDonorSelf = existing.created_by_id === userId;           // 捐贈者本人
const isGridCreator = existing.grid_creator_id === userId;       // 網格建立者
const isGridManager = existing.grid_manager_id === userId;       // 網格管理員
const isAdmin = ['admin', 'super_admin'].includes(req.user.role || '');  // 管理員
const isPrivileged = isAdmin || isGridCreator || isGridManager;  // 特權使用者
```

## 使用說明

### 捐贈者操作流程

1. **確認捐贈**：當準備好捐贈時，點擊「確認」按鈕
2. **標記運送中**：開始配送時，點擊「標記運送中」按鈕
3. **標記到達**：送達目的地時，點擊「確認送達」按鈕
4. **取消捐贈**：可以在 `pledged`、`confirmed`、`in_transit` 階段取消

### 網格建立者/管理員操作

1. **確認收到**：驗收物資後，點擊「確認收到」按鈕
2. **取消捐贈**：可以在任何階段取消不合適的捐贈

### 管理員操作

- 可以執行所有狀態更新操作
- 擁有完整的捐贈管理權限

## 前端支援

前端 `Supplies.jsx` 已在之前的修復中支援所有狀態：
- ✅ `received` 狀態的顯示樣式
- ✅ 「確認收到」按鈕 (當 status === 'delivered')
- ✅ 所有狀態按鈕的顯示邏輯

## 後端自動重載

- 使用 `tsx watch` 監控檔案變更
- 修改 `.ts` 檔案會自動重新啟動後端
- 變更即時生效，無需手動重啟

## 注意事項

1. ✅ 所有狀態轉換都有嚴格的權限控制
2. ✅ 狀態轉換必須遵循預定的流程，不能跳躍
3. ✅ 終止狀態（`received`、`cancelled`）無法再轉換到其他狀態
4. ✅ 後端會自動驗證狀態轉換的合法性和權限
5. ✅ 捐贈者擁有配送過程的控制權
6. ✅ 網格人員負責最終確認收到

## 相關文件

- 初次修復報告: `docs/物資捐贈狀態流程修復報告.md`
- 測試腳本: `packages/backend/scripts/test-supply-status-transition.ts`

## 修復檔案

- `packages/backend/src/routes/supply-donations.ts`
  - Line 128: 新增 `in_transit` 到允許狀態列表
  - Lines 152-159: 更新狀態轉換規則
  - Lines 165-184: 更新權限檢查邏輯（根據使用者需求調整）
