# 視角切換測試指南

## 🧪 測試視角切換功能

### 測試帳號設定

假設您有以下測試帳號：
- **超級管理員**：user.role = 'super_admin'
- **管理員**：user.role = 'admin'
- **網格管理員**：user.role = 'grid_manager'
- **一般用戶**：user.role = 'user'

---

## 1️⃣ 超級管理員視角切換測試

### 可切換的視角
- 訪客視角
- 一般用戶視角
- 網格管理者視角
- 管理員視角
- 超級管理員視角

### 測試步驟

#### A. 切換到「訪客視角」
1. 點擊右上角頭像
2. 點擊「視角: 超管」按鈕
3. 選擇「訪客視角（未登入）」

**預期結果**：
- ✅ 頭像出現灰色光暈
- ✅ 看不到「志工中心」
- ✅ 看不到「管理後台」
- ✅ 只能看到：救援地圖、物資管理、關於我們

#### B. 切換到「一般用戶視角」
1. 點擊右上角頭像
2. 選擇「一般用戶視角」

**預期結果**：
- ✅ 可以看到「志工中心」和「管理後台」
- ✅ 進入管理後台後：
  - ✅ 可以查看所有網格（但只能編輯自己建立的）
  - ✅ 可以查看所有災區（但**不能建立、編輯、刪除**）
  - ❌ **看不到垃圾桶按鈕**
  - ❌ **看不到新增災區按鈕**
  - ❌ **看不到災區的編輯/刪除選項**
  - ❌ **看不到批量操作按鈕**
  - ❌ **看不到全選勾選框**
  - ❌ **看不到匯出/匯入按鈕**

#### C. 切換到「網格管理者視角」
1. 點擊右上角頭像
2. 選擇「網格管理者視角」

**預期結果**：
- ✅ 進入管理後台後：
  - ✅ 可以建立災區（有「新增災區」按鈕）
  - ✅ 可以編輯災區（災區卡片有編輯選項）
  - ✅ 可以刪除災區（災區卡片有刪除選項）
  - ✅ 可以看到「垃圾桶」按鈕
  - ✅ 可以編輯一般用戶建立的網格
  - ✅ 可以看到網格/災區的匯出/匯入按鈕
  - ❌ **看不到志工的匯出/匯入按鈕**
  - ❌ **看不到物資的匯出/匯入按鈕**
  - ❌ **看不到永久刪除按鈕**

#### D. 切換到「管理員視角」
**預期結果**：
- ✅ 所有管理功能
- ✅ 可以看到永久刪除按鈕
- ✅ 可以匯出/匯入志工和物資

---

## 2️⃣ 管理員視角切換測試

### 可切換的視角
- 訪客視角
- 一般用戶視角
- 管理員視角

### 測試步驟

#### A. 切換到「一般用戶視角」
**預期結果**：同超級管理員的「一般用戶視角」測試

#### B. 切換到「訪客視角」
**預期結果**：同超級管理員的「訪客視角」測試

---

## 3️⃣ 網格管理員視角切換測試

### 可切換的視角
- 訪客視角
- 一般用戶視角
- 網格管理者視角

### 測試步驟

#### A. 預設視角（網格管理者視角）
**預期結果**：
- ✅ 可以建立/編輯/刪除災區
- ✅ 可以編輯一般用戶的網格
- ✅ 可以看到垃圾桶
- ✅ 可以匯出/匯入網格和災區
- ❌ 不能匯出/匯入志工和物資
- ❌ 不能永久刪除

#### B. 切換到「一般用戶視角」
**預期結果**：
- ✅ 變成一般用戶權限
- ❌ 看不到垃圾桶
- ❌ 不能建立/編輯/刪除災區
- ❌ 不能編輯他人的網格

#### C. 切換到「訪客視角」
**預期結果**：
- ✅ 變成訪客權限
- ❌ 看不到管理後台

---

## 4️⃣ 一般用戶測試

### 預設視角（一般用戶）

**預期結果**：
- ✅ 可以進入管理後台
- ✅ 可以查看所有網格和災區
- ✅ 可以建立網格
- ✅ 可以編輯**自己建立**的網格
- ✅ 可以刪除**自己建立**的網格（每個網格卡片有垃圾桶圖示）
- ❌ **不能編輯他人的網格**（看不到編輯按鈕）
- ❌ **不能刪除他人的網格**（看不到垃圾桶按鈕）
- ❌ **不能建立災區**（看不到「新增災區」按鈕）
- ❌ **不能編輯災區**（看不到編輯選項）
- ❌ **不能刪除災區**（看不到刪除選項）
- ❌ **看不到垃圾桶按鈕**
- ❌ **看不到批量操作按鈕**
- ❌ **看不到全選勾選框**
- ❌ **看不到任何匯出/匯入按鈕**

---

## 🔍 詳細檢查清單

### 網格卡片檢查（一般用戶視角）

對於**自己建立**的網格：
- ✅ 看到「編輯」按鈕
- ✅ 看到「查看」按鈕
- ✅ 看到「垃圾桶」圖示按鈕

對於**他人建立**的網格：
- ❌ 看不到「編輯」按鈕
- ✅ 看到「查看」按鈕
- ❌ 看不到「垃圾桶」圖示按鈕

### 災區卡片檢查（一般用戶視角）

對於所有災區：
- ❌ 看不到「設定」按鈕（齒輪圖示）
- ❌ 看不到任何操作選項
- ✅ 只能查看災區資訊

### 災區卡片檢查（網格管理員視角）

對於所有災區：
- ✅ 看到「設定」按鈕（齒輪圖示）
- ✅ 點擊後看到「編輯」選項
- ✅ 點擊後看到「刪除」選項

---

## 🐛 常見問題排查

### 問題 1：切換視角後沒有反應
**解決方法**：
1. 檢查 localStorage 中的 `sh-acting-role` 值
2. 重新整理頁面
3. 檢查瀏覽器 Console 是否有錯誤

### 問題 2：權限不符合預期
**檢查項目**：
1. 確認當前 `user.role`（真實角色）
2. 確認當前 `actingRole`（視角角色）
3. 在 Console 輸入查看：
```javascript
// 在瀏覽器 Console 執行
console.log('User role:', user.role);
console.log('Acting role:', actingRole);
console.log('LocalStorage:', localStorage.getItem('sh-acting-role'));
```

### 問題 3：一般用戶可以看到不該看到的功能
**可能原因**：
- `isRegularUser` 檢查失敗
- 權限函數沒有正確調用

**檢查方法**：
```javascript
// 在 Admin.jsx 的 useEffect 中加入 console.log
console.log('isRegularUser:', isRegularUser);
console.log('isGridManager:', isGridManager);
console.log('isAdmin:', isAdmin);
```

---

## ✅ 核心修正

**修正位置**：`src/pages/Admin.jsx:73-76`

**修正前**：
```javascript
const isGridManager = user && (user.role === 'grid_manager' || (user.role === 'super_admin' && actingRole === 'grid_manager'));
```

**修正後**：
```javascript
const isGridManager = user && (
  (user.role === 'grid_manager' && actingRole === 'grid_manager') ||
  (user.role === 'super_admin' && actingRole === 'grid_manager')
);
```

**關鍵改變**：
- 現在 `grid_manager` 真實角色的用戶，只有在 `actingRole === 'grid_manager'` 時才會被視為網格管理員
- 當 `grid_manager` 切換到 `user` 視角時，會變成 `isRegularUser = true`，從而擁有一般用戶權限

---

## 📝 測試記錄範本

| 測試項目 | 真實角色 | 視角角色 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|---------|---------|------|
| 超管→訪客 | super_admin | guest | 看不到管理後台 |  | ⬜ |
| 超管→一般 | super_admin | user | 不能建立災區 |  | ⬜ |
| 超管→格主 | super_admin | grid_manager | 可以建立災區 |  | ⬜ |
| 格主→一般 | grid_manager | user | 不能建立災區 |  | ⬜ |
| 格主→格主 | grid_manager | grid_manager | 可以建立災區 |  | ⬜ |
| 管理→一般 | admin | user | 不能建立災區 |  | ⬜ |
| 一般用戶 | user | user | 不能建立災區 |  | ⬜ |
| 一般用戶 | user | user | 只能編輯自己的網格 |  | ⬜ |
| 一般用戶 | user | user | 看不到垃圾桶 |  | ⬜ |

請按照此測試指南進行完整測試！
