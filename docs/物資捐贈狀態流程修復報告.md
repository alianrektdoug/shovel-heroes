# 物資捐贈狀態流程修復報告

## 問題描述

前端嘗試將物資捐贈狀態更新為 `in_transit`（運送中）時，後端返回 400 錯誤：
```
Failed to update donation status to in_transit: Error: API PUT /supply-donations/84e057ba-61ca-4722-a618-a5383ee8bb73 failed 400: {"message":"Invalid or missing status"}
```

## 根本原因

前端和後端的狀態定義不一致：

### 修復前

**前端狀態流程**：
```
pledged → confirmed → in_transit → delivered
```

**後端狀態流程**：
```
pledged → confirmed → delivered → received
```

### 問題點

1. 前端使用 `in_transit`（運送中），但後端沒有這個狀態
2. 後端使用 `received`（已收到），但前端沒有完整支援

## 修復內容

### 1. 後端修復（supply-donations.ts）

#### 1.1 更新允許的狀態列表（第 132 行）

```typescript
// 修復前
const allowed = ['pledged', 'confirmed', 'delivered', 'received', 'cancelled'];

// 修復後
const allowed = ['pledged', 'confirmed', 'in_transit', 'delivered', 'received', 'cancelled'];
```

#### 1.2 更新狀態轉換規則（第 156-163 行）

```typescript
// 修復後的狀態轉換規則
function canTransition(from: string, to: string) {
  if (from === to) return true;
  if (from === 'pledged') return ['confirmed', 'cancelled'].includes(to);
  if (from === 'confirmed') return ['in_transit', 'cancelled'].includes(to);
  if (from === 'in_transit') return ['delivered', 'cancelled'].includes(to);
  if (from === 'delivered') return ['received'].includes(to);
  return false; // received and cancelled are terminal
}
```

#### 1.3 更新權限規則（第 178 行）

```typescript
// 修復前
} else if (['confirmed', 'delivered', 'received'].includes(status)) {

// 修復後
} else if (['confirmed', 'in_transit', 'delivered', 'received'].includes(status)) {
```

### 2. 前端修復（Supplies.jsx）

#### 2.1 新增 `received` 狀態的顏色和文字（第 126-148 行）

```javascript
// 狀態顏色
case 'received': return 'bg-green-200 text-green-900';

// 狀態文字
case 'received': return '已收到';
```

#### 2.2 新增「確認收到」按鈕（第 578-586 行）

```jsx
{donation.status === 'delivered' && (
  <Button
    size="sm"
    className="bg-green-700 hover:bg-green-800"
    onClick={() => handleStatusUpdate(donation.id, 'received')}
  >
    確認收到
  </Button>
)}
```

## 完整狀態流程

### 正常流程
```
已承諾(pledged)
  → 已確認(confirmed)
  → 運送中(in_transit)
  → 已送達(delivered)
  → 已收到(received)
```

### 取消流程
```
已承諾(pledged) → 已取消(cancelled)
已確認(confirmed) → 已取消(cancelled)
運送中(in_transit) → 已取消(cancelled)
```

### 終止狀態
- `received`（已收到）
- `cancelled`（已取消）
- `delivered`（已送達）無法取消，但可以繼續到 `received`

## 權限控制

### 狀態更新權限

- **捐贈者本人**：可以取消自己的捐贈（`pledged`, `confirmed`, `in_transit` → `cancelled`）
- **網格建立者/管理員**：可以確認、標記運送中、已送達、已收到
- **超級管理員/管理員**：可以進行所有狀態更新操作

### 權限檢查邏輯

```typescript
const isDonorSelf = existing.created_by_id === userId;
const isGridCreator = existing.grid_creator_id === userId;
const isGridManager = existing.grid_manager_id === userId;
const isAdmin = ['admin', 'super_admin'].includes(req.user.role || '');
const isPrivileged = isAdmin || isGridCreator || isGridManager;
```

## 測試驗證

執行測試腳本：
```bash
cd packages/backend
npx tsx scripts/test-supply-status-transition.ts
```

測試結果：
```
✅ 已承諾 → 已確認: PASS
✅ 已確認 → 運送中: PASS
✅ 運送中 → 已送達: PASS
✅ 已送達 → 已收到: PASS
✅ 已承諾 → 已取消: PASS
✅ 已確認 → 已取消: PASS
✅ 運送中 → 已取消: PASS
✅ 已承諾 ✗→ 運送中（需先確認）: PASS
✅ 已承諾 ✗→ 已送達: PASS
✅ 已確認 ✗→ 已送達（需先運送）: PASS
✅ 已送達 ✗→ 已取消（終止狀態）: PASS
✅ 已收到 ✗→ 已取消（終止狀態）: PASS
✅ 已取消 ✗→ 已確認（終止狀態）: PASS

總計: 13 測試
✅ 通過: 13
❌ 失敗: 0
```

## 修復的檔案

1. `packages/backend/src/routes/supply-donations.ts`
   - 新增 `in_transit` 狀態到允許列表
   - 更新狀態轉換規則
   - 更新權限檢查邏輯

2. `src/pages/Supplies.jsx`
   - 新增 `received` 狀態的顏色定義
   - 新增 `received` 狀態的文字定義
   - 新增「確認收到」按鈕

3. `packages/backend/scripts/test-supply-status-transition.ts`（新建）
   - 狀態轉換邏輯測試腳本

## 使用說明

### 網格建立者/管理員操作流程

1. **確認捐贈**：當捐贈者承諾捐贈後，點擊「確認」按鈕
2. **標記運送中**：確認後，點擊「標記運送中」按鈕
3. **確認送達**：物資送達後，點擊「確認送達」按鈕
4. **確認收到**：驗收物資後，點擊「確認收到」按鈕

### 捐贈者操作

- 可以在 `pledged`、`confirmed`、`in_transit` 階段取消自己的捐贈
- 一旦送達（`delivered`）或收到（`received`），無法取消

## 注意事項

1. 所有狀態轉換都有嚴格的權限控制
2. 狀態轉換必須遵循預定的流程，不能跳躍
3. 終止狀態（`received`、`cancelled`）無法再轉換到其他狀態
4. 後端會自動驗證狀態轉換的合法性

## 修復時間

2025-10-05 上午 3:30
