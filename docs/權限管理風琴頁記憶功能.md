# 權限管理風琴頁記憶功能

## 功能說明

權限管理頁面現在會記住使用者上次展開的風琴頁（分類），即使在以下情況下也能保持展開狀態：

- ✅ 儲存變更後
- ✅ 重新整理頁面
- ✅ 離開後再次進入
- ✅ 瀏覽器關閉後重新開啟

## 實作細節

### 1. 狀態儲存

展開狀態儲存在瀏覽器的 `localStorage` 中：

```javascript
// 儲存格式
{
  "基礎管理": true,
  "系統管理": true,
  "垃圾桶管理": false,
  // ...其他分類
}
```

- **Key**: `permission-expanded-categories`
- **Value**: JSON 格式的展開狀態物件

### 2. 初始化

當頁面載入時：
1. 從 `localStorage` 讀取上次儲存的展開狀態
2. 如果沒有儲存的狀態，則預設全部收起
3. 套用到風琴頁元件

### 3. 自動儲存

當使用者進行以下操作時，會自動儲存狀態：
- 點擊風琴頁標題（展開/收起）
- 點擊「全部展開」按鈕
- 點擊「全部收起」按鈕

## 使用方式

### 基本操作

1. **展開單一分類**
   - 點擊分類標題（例如：「基礎管理」）
   - 該分類會展開並顯示權限列表
   - 狀態自動儲存

2. **收起單一分類**
   - 再次點擊已展開的分類標題
   - 該分類會收起
   - 狀態自動儲存

3. **全部展開**
   - 點擊右上角「全部展開」按鈕
   - 所有分類都會展開
   - 狀態自動儲存

4. **全部收起**
   - 點擊右上角「全部收起」按鈕
   - 所有分類都會收起
   - 狀態自動儲存

### 儲存變更後的行為

當使用者修改權限並點擊「儲存變更」後：

**修改前的行為**：
- ❌ 所有風琴頁回到預設狀態（全部收起）
- ❌ 使用者需要重新展開之前正在編輯的分類
- ❌ 不便於連續編輯多個分類

**修改後的行為**：
- ✅ 保持儲存前的展開狀態
- ✅ 使用者可以繼續編輯下一個分類
- ✅ 提升使用體驗和效率

## 測試步驟

### 測試 1: 基本記憶功能

1. 進入「權限管理」頁面
2. 展開「基礎管理」和「系統管理」兩個分類
3. 重新整理頁面（F5 或 Ctrl+R）
4. ✅ 確認「基礎管理」和「系統管理」仍然是展開狀態

### 測試 2: 儲存變更後記憶

1. 展開「人員管理」分類
2. 修改某個權限（例如：勾選/取消某個 checkbox）
3. 點擊「儲存變更」
4. ✅ 確認「人員管理」仍然是展開狀態
5. ✅ 確認其他展開的分類也保持展開

### 測試 3: 全部展開/收起

1. 點擊「全部展開」
2. 重新整理頁面
3. ✅ 確認所有分類都是展開狀態
4. 點擊「全部收起」
5. 重新整理頁面
6. ✅ 確認所有分類都是收起狀態

### 測試 4: 離開後再次進入

1. 展開「資源管理」分類
2. 離開權限管理頁面（切換到其他管理頁面）
3. 再次進入「權限管理」頁面
4. ✅ 確認「資源管理」仍然是展開狀態

### 測試 5: 瀏覽器重啟

1. 展開幾個分類
2. 關閉瀏覽器
3. 重新開啟瀏覽器並登入
4. 進入「權限管理」頁面
5. ✅ 確認之前展開的分類仍然是展開狀態

## 技術實作

### 程式碼位置

- 檔案：`src/components/admin/PermissionManagement.jsx`
- 起始行：約 92-116

### 核心程式碼

```javascript
// 1. 初始化狀態（從 localStorage 讀取）
const [expandedCategories, setExpandedCategories] = useState(() => {
  try {
    const saved = localStorage.getItem('permission-expanded-categories');
    return saved ? JSON.parse(saved) : {};
  } catch {
    return {};
  }
});

// 2. 自動儲存到 localStorage
useEffect(() => {
  try {
    localStorage.setItem('permission-expanded-categories', JSON.stringify(expandedCategories));
  } catch (error) {
    console.error('儲存展開狀態失敗:', error);
  }
}, [expandedCategories]);
```

### 資料流程

```
使用者操作 → 更新 expandedCategories state
             ↓
         觸發 useEffect
             ↓
       儲存到 localStorage
             ↓
    下次載入時自動恢復
```

## 優點

1. **提升使用體驗**
   - 使用者不需要重複展開分類
   - 儲存變更後可以繼續編輯
   - 減少操作步驟

2. **狀態持久化**
   - 即使關閉瀏覽器也能保留
   - 跨頁面導航時也能保留

3. **自動化**
   - 完全自動，無需使用者手動操作
   - 對使用者完全透明

4. **效能優化**
   - 使用 localStorage，不佔用伺服器資源
   - 即時儲存，無延遲

## 注意事項

1. **localStorage 限制**
   - 每個網域約 5-10MB 的儲存空間
   - 本功能使用的空間極小（通常 < 1KB）

2. **隱私模式**
   - 在無痕/隱私模式下，localStorage 可能不可用
   - 會回退到預設行為（全部收起）

3. **清除快取**
   - 如果使用者清除瀏覽器資料，展開狀態會重置
   - 這是正常且預期的行為

4. **相容性**
   - 支援所有現代瀏覽器
   - IE 11+ 也支援

## 清除儲存的狀態

如果需要清除儲存的展開狀態，可以：

### 方法 1: 透過開發者工具

1. 開啟瀏覽器開發者工具（F12）
2. 切換到 Console 標籤
3. 執行：
   ```javascript
   localStorage.removeItem('permission-expanded-categories')
   ```
4. 重新整理頁面

### 方法 2: 點擊「全部收起」

1. 點擊「全部收起」按鈕
2. 這會將所有分類設為收起狀態
3. 並儲存到 localStorage

## 未來改進建議

1. **使用者偏好設定**
   - 允許使用者選擇是否啟用記憶功能
   - 提供「重置展開狀態」按鈕

2. **雲端同步**
   - 將展開狀態儲存到使用者設定檔
   - 支援跨裝置同步

3. **智慧展開**
   - 根據使用者最常編輯的分類，自動展開
   - 分析使用習慣，優化預設狀態

4. **視覺指示**
   - 顯示目前有多少個分類是展開的
   - 提供「展開常用分類」快捷按鈕
