# 測試權限匯出功能

## 改善內容

### 1. 後端驗證 ✅
- 已確認後端從資料庫查詢並匯出正確的權限資料
- 測試腳本 `test-export.ts` 可產生包含 64 筆權限的 CSV 檔案

### 2. 前端改善 ✅
- 加入詳細的 Console 日誌記錄
- 加入匯出狀態顯示（「匯出中...」）
- 加入更完善的錯誤處理
- 驗證檔案大小（防止空檔案）

## 測試步驟

### 步驟 1: 啟動後端伺服器

```bash
cd packages/backend
npm run dev
```

### 步驟 2: 啟動前端應用

```bash
npm run dev
```

### 步驟 3: 登入並測試匯出

1. 使用 **super_admin** 角色的帳號登入
2. 進入「管理後台」→「權限管理」頁面
3. **開啟瀏覽器開發者工具**（按 F12）
4. 切換到 **Console** 標籤
5. 點擊「匯出」按鈕

### 步驟 4: 檢查 Console 日誌

您應該會看到類似以下的日誌：

```
[PermissionManagement] 開始匯出權限
[Export] 開始匯出權限設定
[Export] 回應狀態: 200
[Export] 回應類型: text/csv; charset=utf-8
[Export] Blob 大小: 4049 bytes
[Export] Blob 類型: text/csv
[Export] 匯出完成
[PermissionManagement] 匯出完成
```

### 步驟 5: 驗證下載的 CSV 檔案

1. 檢查下載資料夾中的檔案：`permissions_YYYY-MM-DD.csv`
2. 使用 Excel 或文字編輯器開啟
3. 確認：
   - ✅ 第一行是標題行（ID,角色,權限鍵值...）
   - ✅ 包含所有角色的權限資料（super_admin, admin, grid_manager, user, guest）
   - ✅ 總行數約 65 行（64 筆資料 + 1 標題行）
   - ✅ 中文顯示正常

## 如果遇到問題

### 問題 1: Console 顯示「未登入」

**解決方法**：
1. 確認已登入系統
2. 檢查 localStorage 中的 token：`localStorage.getItem('token')`
3. 如果 token 為空，重新登入

### 問題 2: Console 顯示「403 Forbidden」

**解決方法**：
1. 確認登入的使用者是 super_admin 角色
2. 檢查該角色的 role_permissions 權限：
   ```sql
   SELECT * FROM role_permissions
   WHERE role = 'super_admin'
   AND permission_key = 'role_permissions';
   ```
   確認 `can_manage = 1`

### 問題 3: Blob 大小為 0

**解決方法**：
1. 檢查後端是否正常運行
2. 查看後端 Console 是否有錯誤
3. 執行測試腳本確認資料庫有資料：
   ```bash
   cd packages/backend
   npx tsx scripts/check-permissions.ts
   ```

### 問題 4: 下載的 CSV 內容不對

**可能原因**：
- 瀏覽器快取問題
- 後端回傳的資料格式錯誤

**解決方法**：
1. 清除瀏覽器快取
2. 檢查 Network 標籤中的 API 回應內容
3. 直接在瀏覽器訪問：`http://localhost:3001/api/permissions/export`（需要登入）

## 網路請求檢查

如果仍有問題，在開發者工具的 **Network** 標籤中：

1. 找到 `/api/permissions/export` 請求
2. 檢查：
   - **Request Headers**: 確認有 Authorization header
   - **Response Status**: 應該是 200
   - **Response Headers**: Content-Type 應該是 `text/csv; charset=utf-8`
   - **Response**: 點擊 Preview 或 Response 查看實際內容

## 預期的 CSV 格式範例

```csv
ID,角色,權限鍵值,權限名稱,權限分類,可檢視,可建立,可編輯,可刪除,可管理,說明
28,super_admin,volunteer_registrations,"志工報名","人員管理",1,1,1,1,1,"完整志工報名管理權限"
27,super_admin,volunteers,"志工管理","人員管理",1,1,1,1,1,"完整志工管理權限"
...
```

## 驗證資料正確性

下載的 CSV 應該包含：

- **super_admin**: 16 項權限（所有權限都有 can_manage = 1）
- **admin**: 16 項權限
- **grid_manager**: 16 項權限
- **user**: 16 項權限
- **guest**: 4 項權限

總計：**64 筆權限資料**

## 注意事項

1. 匯出功能需要 `role_permissions` 的 `can_manage` 權限
2. 預設只有 super_admin 可以使用
3. 如需授權給其他角色，請在權限管理頁面手動調整
4. 匯出操作會記錄到稽核日誌

## 下一步

測試完匯出功能後，可以繼續測試匯入功能：
1. 修改匯出的 CSV 檔案
2. 使用匯入按鈕上傳
3. 檢查權限是否更新
